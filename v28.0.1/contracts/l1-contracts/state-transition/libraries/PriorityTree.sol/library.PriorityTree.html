<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PriorityTree - ZKSync Contracts</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../../favicon.png">
        <link rel="stylesheet" href="../../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../../css/general.css">
        <link rel="stylesheet" href="../../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../../book.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ZKSync Contracts</h1>

                    <div class="right-buttons">
                        <a href="../../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/matter-labs/zksync-contracts" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="prioritytree"><a class="header" href="#prioritytree">PriorityTree</a></h1>
<p><a href="https://github.com/matter-labs/zksync-contracts/blob/df3e167e528433a1b7073cb33b1253ee4f052445/contracts/l1-contracts/state-transition/libraries/PriorityTree.sol">Git Source</a></p>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="getfirstunprocessedprioritytx"><a class="header" href="#getfirstunprocessedprioritytx">getFirstUnprocessedPriorityTx</a></h3>
<p>Returns zero if and only if no operations were processed from the tree</p>
<pre><code class="language-solidity">function getFirstUnprocessedPriorityTx(Tree storage _tree)
  internal
  view
  returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>Index of the oldest priority operation that wasn't processed yet</td></tr>
</tbody></table>
</div>
<h3 id="gettotalprioritytxs"><a class="header" href="#gettotalprioritytxs">getTotalPriorityTxs</a></h3>
<pre><code class="language-solidity">function getTotalPriorityTxs(Tree storage _tree)
  internal
  view
  returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>The total number of priority operations that were added to the priority queue, including all processed ones</td></tr>
</tbody></table>
</div>
<h3 id="getsize"><a class="header" href="#getsize">getSize</a></h3>
<pre><code class="language-solidity">function getSize(Tree storage _tree) internal view returns (uint256);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>The total number of unprocessed priority operations in a priority queue</td></tr>
</tbody></table>
</div>
<h3 id="push"><a class="header" href="#push">push</a></h3>
<p>Add the priority operation to the end of the priority queue</p>
<pre><code class="language-solidity">function push(Tree storage _tree, bytes32 _hash) internal;
</code></pre>
<h3 id="setup"><a class="header" href="#setup">setup</a></h3>
<p>Set up the tree</p>
<pre><code class="language-solidity">function setup(Tree storage _tree, uint256 _startIndex) internal;
</code></pre>
<h3 id="getroot"><a class="header" href="#getroot">getRoot</a></h3>
<pre><code class="language-solidity">function getRoot(Tree storage _tree) internal view returns (bytes32);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>bytes32</code></td><td>Returns the tree root.</td></tr>
</tbody></table>
</div>
<h3 id="ishistoricalroot"><a class="header" href="#ishistoricalroot">isHistoricalRoot</a></h3>
<pre><code class="language-solidity">function isHistoricalRoot(Tree storage _tree, bytes32 _root)
  internal
  view
  returns (bool);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tree</code></td><td><code>Tree</code></td><td></td></tr>
<tr><td><code>_root</code></td><td><code>bytes32</code></td><td>The root to check.</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>bool</code></td><td>Returns true if the root is a historical root.</td></tr>
</tbody></table>
</div>
<h3 id="processbatch"><a class="header" href="#processbatch">processBatch</a></h3>
<p>Process the priority operations of a batch.</p>
<p><em>Note, that the function below only checks that a certain segment of items is present in the tree.
It does not check that e.g. there are no zero items inside the provided <code>itemHashes</code>, so in theory proofs
that include non-existing priority operations could be created. This function relies on the fact
that the <code>itemHashes</code> of <code>_priorityOpsData</code> are hashes of valid priority transactions.
This fact is ensured by the fact the rolling hash of those is sent to the Executor by the bootloader
and so assuming that zero knowledge proofs are correct, so is the structure of the <code>itemHashes</code>.</em></p>
<pre><code class="language-solidity">function processBatch(
  Tree storage _tree,
  PriorityOpsBatchInfo memory _priorityOpsData
) internal;
</code></pre>
<h3 id="skipuntil"><a class="header" href="#skipuntil">skipUntil</a></h3>
<p>Allows to skip a certain number of operations.</p>
<p><em>It is used when the corresponding transactions have been processed by priority queue.</em></p>
<pre><code class="language-solidity">function skipUntil(Tree storage _tree, uint256 _lastUnprocessed) internal;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tree</code></td><td><code>Tree</code></td><td></td></tr>
<tr><td><code>_lastUnprocessed</code></td><td><code>uint256</code></td><td>The new expected id of the unprocessed transaction.</td></tr>
</tbody></table>
</div>
<h3 id="initfromcommitment"><a class="header" href="#initfromcommitment">initFromCommitment</a></h3>
<p>Initialize a chain from a commitment.</p>
<pre><code class="language-solidity">function initFromCommitment(
  Tree storage _tree,
  PriorityTreeCommitment memory _commitment
) internal;
</code></pre>
<h3 id="l1reinit"><a class="header" href="#l1reinit">l1Reinit</a></h3>
<p>Reinitialize the tree from a commitment on L1.</p>
<pre><code class="language-solidity">function l1Reinit(Tree storage _tree, PriorityTreeCommitment memory _commitment)
  internal;
</code></pre>
<h3 id="checkgwreinit"><a class="header" href="#checkgwreinit">checkGWReinit</a></h3>
<p>Reinitialize the tree from a commitment on GW.</p>
<pre><code class="language-solidity">function checkGWReinit(
  Tree storage _tree,
  PriorityTreeCommitment memory _commitment
) internal view;
</code></pre>
<h3 id="getcommitment"><a class="header" href="#getcommitment">getCommitment</a></h3>
<p>Returns the commitment to the priority tree.</p>
<pre><code class="language-solidity">function getCommitment(Tree storage _tree)
  internal
  view
  returns (PriorityTreeCommitment memory commitment);
</code></pre>
<h2 id="structs"><a class="header" href="#structs">Structs</a></h2>
<h3 id="tree"><a class="header" href="#tree">Tree</a></h3>
<pre><code class="language-solidity">struct Tree {
  uint256 startIndex;
  uint256 unprocessedIndex;
  mapping(bytes32 =&gt; bool) historicalRoots;
  DynamicIncrementalMerkle.Bytes32PushTree tree;
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../../contracts/l1-contracts/state-transition/libraries/PriorityQueue.sol/library.PriorityQueue.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../../../contracts/l2-contracts/SystemContractsCaller.sol/library.SystemContractsCaller.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../../contracts/l1-contracts/state-transition/libraries/PriorityQueue.sol/library.PriorityQueue.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../../../contracts/l2-contracts/SystemContractsCaller.sol/library.SystemContractsCaller.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../../elasticlunr.min.js"></script>
        <script src="../../../../../mark.min.js"></script>
        <script src="../../../../../searcher.js"></script>

        <script src="../../../../../clipboard.min.js"></script>
        <script src="../../../../../highlight.js"></script>
        <script src="../../../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../../../solidity.min.js"></script>


    </div>
    </body>
</html>
